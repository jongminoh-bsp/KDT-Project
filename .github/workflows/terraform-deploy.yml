name: ğŸš€ Terraform Infrastructure Deployment

on:
  # push:  # Q Auto Deploy ì‹œìŠ¤í…œìœ¼ë¡œ ì™„ì „ ëŒ€ì²´ë¨
  #   branches: [ develop ]
  #   paths:
  #     - 'infra/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'infra/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - prod
      action:
        description: 'Terraform action'
        required: true
        default: 'plan'
        type: choice
        options:
        - plan
        - apply
        - destroy
      change_summary:
        description: 'Summary of infrastructure changes'
        required: false
        type: string

env:
  TF_VERSION: '1.9.8'
  AWS_REGION: 'ap-northeast-2'

jobs:
  terraform-check:
    name: ğŸ” Terraform Validation
    runs-on: ubuntu-latest
    outputs:
      tf-changes: ${{ steps.changes.outputs.terraform }}
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ” Detect Changes
      uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          terraform:
            - 'infra/**/*.tf'
            - 'infra/**/*.tfvars'
            
    - name: âš™ï¸ Setup Terraform
      if: steps.changes.outputs.terraform == 'true'
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        
    - name: ğŸ¨ Terraform Format Check & Auto-fix
      if: steps.changes.outputs.terraform == 'true'
      run: |
        cd infra/dev/terraform
        
        # í¬ë§· ì²´í¬ ë° ìë™ ìˆ˜ì •
        if ! terraform fmt -check -recursive; then
          echo "âš ï¸ Terraform files need formatting. Auto-fixing..."
          terraform fmt -recursive
          echo "ğŸ”§ Terraform files have been formatted"
          echo "::notice::Terraform files were automatically formatted"
        else
          echo "âœ… All Terraform files are properly formatted"
        fi
        
    - name: âœ… Terraform Validate
      if: steps.changes.outputs.terraform == 'true'
      run: |
        cd infra/dev/terraform
        terraform init -backend=false
        terraform validate

  terraform-plan:
    name: ğŸ“‹ Terraform Plan
    runs-on: ubuntu-latest
    needs: terraform-check
    if: needs.terraform-check.outputs.tf-changes == 'true'
    environment: 
      name: ${{ github.event.inputs.environment || 'dev' }}
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ” Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: âš™ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        
    - name: ğŸš€ Terraform Init
      run: |
        cd infra/dev/terraform
        terraform init
        
    - name: ğŸ“‹ Terraform Plan
      id: plan
      run: |
        cd infra/dev/terraform
        terraform plan -no-color -out=tfplan
        terraform show -no-color tfplan > plan.txt
        
    - name: ğŸ“ Comment Plan on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const plan = fs.readFileSync('infra/dev/terraform/plan.txt', 'utf8');
          const maxLength = 65000;
          const truncatedPlan = plan.length > maxLength ? 
            plan.substring(0, maxLength) + '\n... (truncated)' : plan;
          
          const output = `## ğŸš€ Terraform Plan Results
          
          <details>
          <summary>ğŸ“‹ Click to expand plan</summary>
          
          \`\`\`terraform
          ${truncatedPlan}
          \`\`\`
          
          </details>
          
          **Environment**: \`${{ github.event.inputs.environment || 'dev' }}\`
          **Triggered by**: @${{ github.actor }}
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          });
          
    - name: ğŸ’¾ Upload Plan Artifact
      uses: actions/upload-artifact@v4
      with:
        name: terraform-plan
        path: infra/dev/terraform/tfplan
        retention-days: 5

  terraform-apply:
    name: ğŸš€ Terraform Apply
    runs-on: ubuntu-latest
    needs: [terraform-check, terraform-plan]
    if: |
      needs.terraform-check.outputs.tf-changes == 'true' && 
      (github.ref == 'refs/heads/main' || 
       github.ref == 'refs/heads/develop' || 
       github.event.inputs.action == 'apply')
    environment: 
      name: ${{ github.event.inputs.environment || 'dev' }}
      url: https://console.aws.amazon.com/
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ” Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: âš™ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        
    - name: ğŸš€ Terraform Init
      run: |
        cd infra/dev/terraform
        terraform init
        
    - name: ğŸ“¥ Download Plan Artifact
      if: github.event.inputs.action != 'destroy'
      uses: actions/download-artifact@v4
      with:
        name: terraform-plan
        path: infra/dev/terraform/
        
    - name: ğŸš€ Terraform Apply
      if: github.event.inputs.action != 'destroy'
      run: |
        cd infra/dev/terraform
        terraform apply -auto-approve tfplan
        
    - name: ğŸ’¥ Terraform Destroy
      if: github.event.inputs.action == 'destroy'
      run: |
        cd infra/dev/terraform
        terraform destroy -auto-approve
        
    - name: ğŸ“Š Generate Infrastructure Report
      if: github.event.inputs.action != 'destroy'
      run: |
        cd infra/dev/terraform
        echo "## ğŸ—ï¸ Infrastructure Deployment Report" > deployment-report.md
        echo "" >> deployment-report.md
        echo "**Environment**: \`${{ github.event.inputs.environment || 'dev' }}\`" >> deployment-report.md
        echo "**Deployed by**: @${{ github.actor }}" >> deployment-report.md
        echo "**Timestamp**: $(date -u)" >> deployment-report.md
        echo "" >> deployment-report.md
        echo "### ğŸ“‹ Applied Resources" >> deployment-report.md
        terraform show -json | jq -r '.values.root_module.resources[] | "- \(.type): \(.name)"' >> deployment-report.md || echo "- Resource list generation failed" >> deployment-report.md
        
    - name: ğŸ’¾ Upload Deployment Report
      if: github.event.inputs.action != 'destroy'
      uses: actions/upload-artifact@v4
      with:
        name: deployment-report
        path: infra/dev/terraform/deployment-report.md
        retention-days: 30

  notify-success:
    name: ğŸ‰ Notify Success
    runs-on: ubuntu-latest
    needs: [terraform-apply]
    if: success()
    
    steps:
    - name: ğŸ‰ Success Notification
      run: |
        echo "ğŸš€ Infrastructure deployment completed successfully!"
        echo "Environment: ${{ github.event.inputs.environment || 'dev' }}"
        echo "Action: ${{ github.event.inputs.action || 'apply' }}"
        echo "Triggered by: ${{ github.actor }}"
        
    - name: ğŸ“¢ Slack Success Notification
      if: env.SLACK_WEBHOOK_URL != ''
      uses: 8398a7/action-slack@v3
      with:
        status: success
        channel: '#infrastructure'
        username: 'Terraform Bot'
        icon_emoji: ':rocket:'
        title: 'ğŸš€ Infrastructure Deployment Success'
        text: |
          *Environment:* ${{ github.event.inputs.environment || 'dev' }}
          *Action:* ${{ github.event.inputs.action || 'apply' }}
          *Triggered by:* ${{ github.actor }}
          *Branch:* ${{ github.ref_name }}
          *Commit:* ${{ github.sha }}
          
          âœ… All infrastructure changes have been applied successfully!
          
          ${{ github.event.inputs.change_summary && format('**ğŸ“‹ Changes Applied:**
          {0}', github.event.inputs.change_summary) || '' }}
        fields: |
          [
            {
              "title": "Repository",
              "value": "${{ github.repository }}",
              "short": true
            },
            {
              "title": "Workflow",
              "value": "${{ github.workflow }}",
              "short": true
            }
          ]
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  notify-failure:
    name: âŒ Notify Failure
    runs-on: ubuntu-latest
    needs: [terraform-check, terraform-plan, terraform-apply]
    if: failure()
    
    steps:
    - name: âŒ Failure Notification
      run: |
        echo "ğŸ’¥ Infrastructure deployment failed!"
        
    - name: ğŸ“¢ Slack Failure Notification
      if: env.SLACK_WEBHOOK_URL != ''
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        channel: '#infrastructure'
        username: 'Terraform Bot'
        icon_emoji: ':warning:'
        title: 'âŒ Infrastructure Deployment Failed'
        text: |
          *Environment:* ${{ github.event.inputs.environment || 'dev' }}
          *Action:* ${{ github.event.inputs.action || 'apply' }}
          *Triggered by:* ${{ github.actor }}
          *Branch:* ${{ github.ref_name }}
          *Commit:* ${{ github.sha }}
          
          ğŸ’¥ Infrastructure deployment encountered errors. Please check the logs.
          
          ${{ github.event.inputs.change_summary && format('**ğŸ“‹ Attempted Changes:**
          {0}', github.event.inputs.change_summary) || '' }}
        fields: |
          [
            {
              "title": "Repository",
              "value": "${{ github.repository }}",
              "short": true
            },
            {
              "title": "Workflow Run",
              "value": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "short": true
            }
          ]
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
