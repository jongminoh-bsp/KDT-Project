name: ğŸ” Infrastructure Change Detection

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'infra/requirements/infrastructure-spec.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'infra/requirements/infrastructure-spec.yml'

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  detect-changes:
    name: ğŸ” Detect Infrastructure Changes
    runs-on: ubuntu-latest
    
    outputs:
      changes-detected: ${{ steps.changes.outputs.changes-detected }}
      change-summary: ${{ steps.analyze.outputs.summary }}
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
        
    - name: ğŸ” Detect Spec Changes
      id: changes
      run: |
        if git diff --name-only HEAD~1 HEAD | grep -q "infra/requirements/infrastructure-spec.yml"; then
          echo "changes-detected=true" >> $GITHUB_OUTPUT
          echo "âœ… Infrastructure spec changes detected"
        else
          echo "changes-detected=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ No infrastructure spec changes"
        fi
        
    - name: ğŸ“Š Analyze Changes
      id: analyze
      if: steps.changes.outputs.changes-detected == 'true'
      run: |
        echo "ğŸ” Analyzing infrastructure specification changes..."
        
        # ë³€ê²½ëœ ë¼ì¸ ìˆ˜ ê³„ì‚°
        LINES_CHANGED=$(git diff HEAD~1 HEAD infra/requirements/infrastructure-spec.yml | grep -E '^[+-]' | grep -v '^[+-]{3}' | wc -l)
        
        # ì£¼ìš” ì„¹ì…˜ ë³€ê²½ ê°ì§€
        CHANGED_SECTIONS=""
        if git diff HEAD~1 HEAD infra/requirements/infrastructure-spec.yml | grep -q "network:"; then
          CHANGED_SECTIONS="$CHANGED_SECTIONS Network,"
        fi
        if git diff HEAD~1 HEAD infra/requirements/infrastructure-spec.yml | grep -q "compute:"; then
          CHANGED_SECTIONS="$CHANGED_SECTIONS Compute,"
        fi
        if git diff HEAD~1 HEAD infra/requirements/infrastructure-spec.yml | grep -q "kubernetes:"; then
          CHANGED_SECTIONS="$CHANGED_SECTIONS Kubernetes,"
        fi
        if git diff HEAD~1 HEAD infra/requirements/infrastructure-spec.yml | grep -q "database:"; then
          CHANGED_SECTIONS="$CHANGED_SECTIONS Database,"
        fi
        if git diff HEAD~1 HEAD infra/requirements/infrastructure-spec.yml | grep -q "security:"; then
          CHANGED_SECTIONS="$CHANGED_SECTIONS Security,"
        fi
        
        CHANGED_SECTIONS=${CHANGED_SECTIONS%,}  # ë§ˆì§€ë§‰ ì‰¼í‘œ ì œê±°
        
        SUMMARY="ğŸ“Š Infrastructure Changes Detected:
        - Lines changed: $LINES_CHANGED
        - Affected sections: ${CHANGED_SECTIONS:-None}
        - Triggered by: @${{ github.actor }}"
        
        echo "summary<<EOF" >> $GITHUB_OUTPUT
        echo "$SUMMARY" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        echo "$SUMMARY"

  generate-terraform-vars:
    name: ğŸ”„ Generate Terraform Variables
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.changes-detected == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        pip install pyyaml
        
    - name: ğŸ”„ Generate Terraform Variables
      run: |
        python scripts/generate-terraform-vars.py
        
    - name: ğŸ“ Check Generated Changes
      id: check-changes
      run: |
        if git diff --quiet infra/dev/terraform/terraform.tfvars; then
          echo "terraform-changed=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ No Terraform variable changes generated"
        else
          echo "terraform-changed=true" >> $GITHUB_OUTPUT
          echo "âœ… Terraform variables updated"
          echo "ğŸ“‹ Changes:"
          git diff infra/dev/terraform/terraform.tfvars
        fi
        
    - name: ğŸ’¾ Commit Generated Variables
      if: steps.check-changes.outputs.terraform-changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add infra/dev/terraform/terraform.tfvars
        git commit -m "auto: Update Terraform variables from infrastructure spec

        ${{ needs.detect-changes.outputs.change-summary }}
        
        Generated by: Infrastructure Change Detection
        Commit: ${{ github.sha }}"
        
    - name: ğŸš€ Push Changes
      if: steps.check-changes.outputs.terraform-changed == 'true'
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}

  trigger-deployment:
    name: ğŸš€ Trigger Infrastructure Deployment
    runs-on: ubuntu-latest
    needs: [detect-changes, generate-terraform-vars]
    if: |
      needs.detect-changes.outputs.changes-detected == 'true' && 
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ” Check for Resource Scan Request
      id: check-scan
      run: |
        if grep -q "trigger.*true" infra/requirements/infrastructure-spec.yml; then
          echo "resource-scan-requested=true" >> $GITHUB_OUTPUT
          echo "ğŸ” Resource scan requested"
        else
          echo "resource-scan-requested=false" >> $GITHUB_OUTPUT
        fi
        
    - name: ğŸš€ Trigger Terraform Deployment
      if: steps.check-scan.outputs.resource-scan-requested != 'true'
      uses: actions/github-script@v7
      env:
        CHANGE_SUMMARY: ${{ needs.detect-changes.outputs.change-summary }}
      with:
        script: |
          const result = await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'terraform-deploy.yml',
            ref: context.ref,
            inputs: {
              environment: 'dev',
              action: 'apply',
              change_summary: process.env.CHANGE_SUMMARY || ''
            }
          });
          
          console.log('ğŸš€ Terraform deployment triggered');
          console.log('Workflow run:', result.status);
          console.log('Change summary:', process.env.CHANGE_SUMMARY);
          
    - name: ğŸ” Trigger Resource Scanner (Manual Alternative)
      if: steps.check-scan.outputs.resource-scan-requested == 'true'
      run: |
        echo "ğŸ” Resource scan requested!"
        echo "ğŸ“‹ Manual execution required:"
        echo "1. Go to GitHub Actions"
        echo "2. Select 'Unused Resource Scanner' workflow"
        echo "3. Click 'Run workflow'"
        echo "4. Select scan_type: full"
        echo ""
        echo "âš ï¸ Automatic trigger will be available after main branch sync"
          
    - name: ğŸ“ Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const comment = `## ğŸš€ Infrastructure Changes Detected
          
          ${{ needs.detect-changes.outputs.change-summary }}
          
          ### ğŸ”„ Next Steps
          - âœ… Terraform variables have been auto-generated
          - ğŸš€ Infrastructure deployment will be triggered after merge
          - ğŸ“Š Review the changes in the Terraform plan
          
          **Note**: This is an automated infrastructure change detection.
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  notify-completion:
    name: ğŸ‰ Notify Completion
    runs-on: ubuntu-latest
    needs: [detect-changes, generate-terraform-vars, trigger-deployment]
    if: always() && needs.detect-changes.outputs.changes-detected == 'true'
    
    steps:
    - name: ğŸ‰ Success Notification
      if: needs.trigger-deployment.result == 'success'
      run: |
        echo "ğŸ‰ Infrastructure change detection completed successfully!"
        echo "${{ needs.detect-changes.outputs.change-summary }}"
        echo "ğŸš€ Terraform deployment has been triggered"
        
    - name: âš ï¸ Partial Success Notification
      if: needs.generate-terraform-vars.result == 'success' && needs.trigger-deployment.result != 'success'
      run: |
        echo "âš ï¸ Infrastructure changes detected and variables generated"
        echo "${{ needs.detect-changes.outputs.change-summary }}"
        echo "â„¹ï¸ Manual deployment may be required"
