name: Terraform Infrastructure PR Automation

on:
  push:
    branches:
      - develop
    paths:
      - 'test/skyline-infrastructure/**'
      - '!test/skyline-infrastructure/README.md'

jobs:
  create-infrastructure-pr:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.0

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-northeast-2

    - name: Terraform Format Check
      run: |
        cd test/skyline-infrastructure
        terraform fmt -check -recursive

    - name: Terraform Validate
      run: |
        cd test/skyline-infrastructure
        terraform init -backend=false
        terraform validate

    - name: Generate PR branch name
      id: branch
      run: |
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        BRANCH_NAME="infrastructure/skyline-${TIMESTAMP}"
        echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT

    - name: Create infrastructure branch
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git checkout -b ${{ steps.branch.outputs.branch_name }}
        git push origin ${{ steps.branch.outputs.branch_name }}

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ steps.branch.outputs.branch_name }}
        base: main
        title: "ğŸ—ï¸ Infrastructure: Deploy Skyline Application Infrastructure"
        body: |
          ## ğŸ“‹ Infrastructure Deployment Request
          
          ### ğŸ¯ ëª©ì 
          Skyline í•­ê³µì˜ˆì•½ì‹œìŠ¤í…œì„ ìœ„í•œ AWS ì¸í”„ë¼ ë°°í¬ ìš”ì²­
          
          ### ğŸ—ï¸ ë°°í¬ë  ë¦¬ì†ŒìŠ¤
          - **VPC**: 10.0.0.0/16, 2ê°œ AZ, Public/Private ì„œë¸Œë„·
          - **EKS**: Kubernetes 1.28 í´ëŸ¬ìŠ¤í„° + t3.medium ë…¸ë“œ 2ê°œ
          - **RDS**: MySQL 8.0 (db.t3.micro, ì•”í˜¸í™” ì ìš©)
          - **ECR**: Docker ì´ë¯¸ì§€ ì €ì¥ì†Œ
          - **ë³´ì•ˆ**: IAM ì—­í• , ë³´ì•ˆê·¸ë£¹, Secrets Manager
          
          ### ğŸ’° ì˜ˆìƒ ë¹„ìš© (ì›”ê°„)
          - EKS í´ëŸ¬ìŠ¤í„°: $73
          - EC2 ë…¸ë“œ: $60
          - RDS: $15
          - NAT Gateway: $45
          - **ì´ ì˜ˆìƒ: ~$193/ì›”**
          
          ### ğŸ”’ ë³´ì•ˆ ê²€í†  ì‚¬í•­
          - [x] RDS ë¹„ë°€ë²ˆí˜¸ Secrets Manager ê´€ë¦¬
          - [x] EKS ë…¸ë“œ Private ì„œë¸Œë„· ë°°ì¹˜
          - [x] ìµœì†Œ ê¶Œí•œ ë³´ì•ˆê·¸ë£¹ ì„¤ì •
          - [x] ëª¨ë“  ë¦¬ì†ŒìŠ¤ ì•”í˜¸í™” ì ìš©
          
          ### âœ… ì‚¬ì „ ê²€ì¦ ì™„ë£Œ
          - [x] Terraform í¬ë§· ê²€ì‚¬
          - [x] Terraform êµ¬ë¬¸ ê²€ì¦
          - [x] ëª¨ë“ˆ êµ¬ì¡° ê²€í† 
          
          ### ğŸš€ ë°°í¬ í›„ ì‘ì—…
          1. EKS í´ëŸ¬ìŠ¤í„° ì ‘ê·¼ ì„¤ì •
          2. Kubernetes ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë°°í¬
          3. ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ì²´í¬
          
          ---
          
          **âš ï¸ ì£¼ì˜**: ì´ PRì´ ìŠ¹ì¸ë˜ë©´ ì‹¤ì œ AWS ë¦¬ì†ŒìŠ¤ê°€ ìƒì„±ë˜ë©° ë¹„ìš©ì´ ë°œìƒí•©ë‹ˆë‹¤.
          
          **ğŸ‘¥ ë¦¬ë·°ì–´**: @jongminoh-bsp (ì¸í”„ë¼ ê´€ë¦¬ì ìŠ¹ì¸ í•„ìš”)
        labels: |
          infrastructure
          terraform
          aws
          review-required
        reviewers: |
          jongminoh-bsp
        assignees: |
          jongminoh-bsp
