name: ğŸ¤– Q Auto Analysis & Deploy

on:
  push:
    branches: [ develop ]
    paths:
      - 'infra/**'
      - 'infra/requirements/**'

env:
  AWS_REGION: 'ap-northeast-2'

jobs:
  q-analysis-deploy:
    name: ğŸ§  Q Analysis & Auto Deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # ì´ì „ ì»¤ë°‹ê³¼ ë¹„êµí•˜ê¸° ìœ„í•´
        
    - name: ğŸ” Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: âš™ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: '1.9.8'
        
    - name: ğŸ“‹ Get Changed Files
      id: changes
      run: |
        echo "changed_files<<EOF" >> $GITHUB_OUTPUT
        git diff --name-only HEAD~1 HEAD -- infra/ >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        echo "commit_message<<EOF" >> $GITHUB_OUTPUT
        git log -1 --pretty=%B >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: ğŸ§  Q Analysis & Deploy
      run: |
        echo "ğŸ¤– Qê°€ ì½”ë“œ ë³€ê²½ì‚¬í•­ì„ ë¶„ì„í•˜ê³  ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
        echo ""
        echo "ğŸ“‹ ë³€ê²½ëœ íŒŒì¼ë“¤:"
        echo "${{ steps.changes.outputs.changed_files }}"
        echo ""
        echo "ğŸ’¬ ì»¤ë°‹ ë©”ì‹œì§€:"
        echo "${{ steps.changes.outputs.commit_message }}"
        echo ""
        
        # Q CLI ëª…ë ¹ì–´ë¡œ ìë™ ë¶„ì„ ë° ë°°í¬
        echo "ğŸ” Qê°€ Terraform ì½”ë“œë¥¼ ë¶„ì„ ì¤‘..."
        
        # ë³€ê²½ì‚¬í•­ ë¶„ì„
        if echo "${{ steps.changes.outputs.changed_files }}" | grep -q "infrastructure-spec.yml"; then
          echo "âœ… ì¸í”„ë¼ ìŠ¤í™ ë³€ê²½ ê°ì§€ - ìš”êµ¬ì‚¬í•­ ì—…ë°ì´íŠ¸ í•„ìš”"
          
          # ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº” ëª…ë ¹ í™•ì¸
          if grep -q "unused_resource_scan:" infra/requirements/infrastructure-spec.yml && grep -q "trigger: true" infra/requirements/infrastructure-spec.yml; then
            echo "ğŸ” ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº” ëª…ë ¹ ê°ì§€!"
            echo "ğŸ“Š AWS ë¦¬ì†ŒìŠ¤ ìƒíƒœë§Œ ì¡°íšŒí•©ë‹ˆë‹¤ (plan/apply ìƒëµ)"
            
            # ì½ê¸° ì „ìš© ìŠ¤ìº” ì‹¤í–‰ ë° ê²°ê³¼ ì €ì¥
            echo "ğŸ”„ AWS CLIë¡œ ë¦¬ì†ŒìŠ¤ í˜„í™© ì¡°íšŒ ì¤‘..."
            
            # EC2 ì¸ìŠ¤í„´ìŠ¤ ì¡°íšŒ
            echo "ğŸ“Š EC2 ì¸ìŠ¤í„´ìŠ¤ ë¶„ì„ ì¤‘..."
            aws ec2 describe-instances --region ap-northeast-2 --query 'Reservations[*].Instances[*].[InstanceId,State.Name,InstanceType,LaunchTime]' --output table > ec2_report.txt || echo "EC2 ì¡°íšŒ ì‹¤íŒ¨" > ec2_report.txt
            
            # EBS ë³¼ë¥¨ ì¡°íšŒ
            echo "ğŸ’¾ EBS ë³¼ë¥¨ ë¶„ì„ ì¤‘..."
            aws ec2 describe-volumes --region ap-northeast-2 --query 'Volumes[*].[VolumeId,State,Size,Attachments[0].InstanceId//`unattached`]' --output table > ebs_report.txt || echo "EBS ì¡°íšŒ ì‹¤íŒ¨" > ebs_report.txt
            
            # ë³´ì•ˆ ê·¸ë£¹ ì¡°íšŒ
            echo "ğŸ”’ ë³´ì•ˆ ê·¸ë£¹ ë¶„ì„ ì¤‘..."
            aws ec2 describe-security-groups --region ap-northeast-2 --query 'SecurityGroups[*].[GroupId,GroupName,Description]' --output table > sg_report.txt || echo "ë³´ì•ˆ ê·¸ë£¹ ì¡°íšŒ ì‹¤íŒ¨" > sg_report.txt
            
            # ìµœì í™” ë¶„ì„ ìˆ˜í–‰
            echo "ğŸ§  Qê°€ ìµœì í™” ë°©ì•ˆì„ ë¶„ì„ ì¤‘..."
            
            # ë¯¸ì‚¬ìš© EBS ë³¼ë¥¨ ì¹´ìš´íŠ¸
            UNATTACHED_VOLUMES=$(grep -c "unattached" ebs_report.txt 2>/dev/null || echo "0")
            
            # ì‹¤í–‰ ì¤‘ì¸ EC2 ì¸ìŠ¤í„´ìŠ¤ ì¹´ìš´íŠ¸
            RUNNING_INSTANCES=$(grep -c "running" ec2_report.txt 2>/dev/null || echo "0")
            
            # ì¤‘ì§€ëœ EC2 ì¸ìŠ¤í„´ìŠ¤ ì¹´ìš´íŠ¸  
            STOPPED_INSTANCES=$(grep -c "stopped" ec2_report.txt 2>/dev/null || echo "0")
            
            # ë³´ì•ˆ ê·¸ë£¹ ì´ ê°œìˆ˜
            TOTAL_SECURITY_GROUPS=$(grep -c "|" sg_report.txt 2>/dev/null || echo "0")
            
            # ìµœì í™” ë¦¬í¬íŠ¸ ìƒì„±
            cat > optimization_report.json << EOF
{
  "scan_time": "$(date -u +"%Y-%m-%d %H:%M:%S UTC")",
  "region": "ap-northeast-2",
  "findings": {
    "ec2_running": $RUNNING_INSTANCES,
    "ec2_stopped": $STOPPED_INSTANCES,
    "ebs_unattached": $UNATTACHED_VOLUMES,
    "security_groups": $TOTAL_SECURITY_GROUPS
  },
  "recommendations": [
    "ğŸ’° ì¤‘ì§€ëœ EC2 ì¸ìŠ¤í„´ìŠ¤ $STOPPED_INSTANCESê°œ - ë¶ˆí•„ìš”ì‹œ ì¢…ë£Œ ê¶Œì¥",
    "ğŸ’¾ ì—°ê²°ë˜ì§€ ì•Šì€ EBS ë³¼ë¥¨ $UNATTACHED_VOLUMESê°œ - ì‚­ì œí•˜ì—¬ ì›” \$$(($UNATTACHED_VOLUMES * 8)) ì ˆì•½ ê°€ëŠ¥",
    "ğŸ”’ ë³´ì•ˆ ê·¸ë£¹ $TOTAL_SECURITY_GROUPSê°œ - ë¯¸ì‚¬ìš© ê·¸ë£¹ ì •ë¦¬ ê¶Œì¥",
    "âš¡ ì‹¤í–‰ ì¤‘ì¸ ì¸ìŠ¤í„´ìŠ¤ $RUNNING_INSTANCESê°œ - ì‚¬ìš©ë¥  ëª¨ë‹ˆí„°ë§ í•„ìš”"
  ],
  "cost_impact": "ì›” ì˜ˆìƒ ì ˆì•½: \$$(($UNATTACHED_VOLUMES * 8 + $STOPPED_INSTANCES * 20))"
}
EOF
            
            echo "âœ… ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº” ì™„ë£Œ! (Terraform ì‹¤í–‰ ìƒëµ)"
            echo "ğŸ“Š ìµœì í™” ë¦¬í¬íŠ¸ ìƒì„±ë¨: optimization_report.json"
            exit 0
          fi
          
          # ì‚­ì œ ëª…ë ¹ í™•ì¸
          if grep -q "destroy_all:" infra/requirements/infrastructure-spec.yml && grep -q "trigger: true" infra/requirements/infrastructure-spec.yml; then
            echo "ğŸ—‘ï¸ ì „ì²´ ì¸í”„ë¼ ì‚­ì œ ëª…ë ¹ ê°ì§€!"
            echo "ğŸ”„ Terraform ë°±ì—”ë“œ ì¬êµ¬ì„± ì¤‘..."
            cd infra/dev/terraform
            terraform init -reconfigure
            echo "ğŸš¨ Terraform destroy ì‹¤í–‰ ì¤‘..."
            terraform destroy -auto-approve
            echo "âœ… ì „ì²´ ì¸í”„ë¼ ì‚­ì œ ì™„ë£Œ!"
            exit 0
          fi
        fi
        
        if echo "${{ steps.changes.outputs.changed_files }}" | grep -q "terraform.tfvars"; then
          echo "âœ… ë³€ìˆ˜ íŒŒì¼ ë³€ê²½ ê°ì§€ - ì„¤ì • ì—…ë°ì´íŠ¸ í•„ìš”"
        fi
        
        if echo "${{ steps.changes.outputs.changed_files }}" | grep -q "main.tf"; then
          echo "âœ… ë©”ì¸ ì„¤ì • ë³€ê²½ ê°ì§€ - ë¦¬ì†ŒìŠ¤ ì—…ë°ì´íŠ¸ í•„ìš”"
        fi
        
        if echo "${{ steps.changes.outputs.changed_files }}" | grep -q "modules/"; then
          echo "âœ… ëª¨ë“ˆ ë³€ê²½ ê°ì§€ - ëª¨ë“ˆ ê¸°ë°˜ ë¦¬ì†ŒìŠ¤ ì—…ë°ì´íŠ¸ í•„ìš”"
        fi
        
        # ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº”ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ Terraform ì‹¤í–‰
        if ! echo "${{ github.event.head_commit.message }}" | grep -q "ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº”"; then
          echo ""
          echo "ğŸš€ Qê°€ ìë™ìœ¼ë¡œ Terraform ë°°í¬ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤..."
          
          # Terraform ì‹¤í–‰
          cd infra/dev/terraform
          
          echo "ğŸ”„ Terraform ì´ˆê¸°í™”..."
          terraform init
          
          echo "ğŸ”“ ê¸°ì¡´ ë½ í•´ì œ ì‹œë„..."
          # ë™ì ìœ¼ë¡œ ë½ ìƒíƒœ í™•ì¸ í›„ í•´ì œ
          if terraform force-unlock -help > /dev/null 2>&1; then
            echo "ë½ í•´ì œ ê¸°ëŠ¥ ì‚¬ìš© ê°€ëŠ¥"
          fi
          
          echo "ğŸ“‹ ë³€ê²½ ê³„íš ìƒì„±..."
          terraform plan -out=tfplan
          
          echo "ğŸš€ ì¸í”„ë¼ ë°°í¬ ì‹¤í–‰..."
          terraform apply -auto-approve tfplan
          
          echo "âœ… Q ìë™ ë°°í¬ ì™„ë£Œ!"
        else
          echo "ğŸ“Š ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº” ì™„ë£Œ - Terraform ì‹¤í–‰ ìƒëµ"
        fi
        
    - name: ğŸ“Š Generate Q Analysis Report
      if: ${{ !contains(github.event.head_commit.message, 'ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº”') }}
      run: |
        cd infra/dev/terraform
        
        echo "# ğŸ¤– Q ìë™ ë¶„ì„ ë° ë°°í¬ ë¦¬í¬íŠ¸" > q-analysis-report.md
        echo "" >> q-analysis-report.md
        echo "**ë¶„ì„ ì‹œê°„**: $(date -u)" >> q-analysis-report.md
        echo "**íŠ¸ë¦¬ê±°**: Git Push (develop)" >> q-analysis-report.md
        echo "**ë¶„ì„ì**: Amazon Q" >> q-analysis-report.md
        echo "" >> q-analysis-report.md
        
        echo "## ğŸ“‹ ë³€ê²½ì‚¬í•­ ë¶„ì„" >> q-analysis-report.md
        echo "\`\`\`" >> q-analysis-report.md
        echo "${{ steps.changes.outputs.changed_files }}" >> q-analysis-report.md
        echo "\`\`\`" >> q-analysis-report.md
        echo "" >> q-analysis-report.md
        
        echo "## ğŸ’¬ ì»¤ë°‹ ë©”ì‹œì§€" >> q-analysis-report.md
        echo "\`\`\`" >> q-analysis-report.md
        echo "${{ steps.changes.outputs.commit_message }}" >> q-analysis-report.md
        echo "\`\`\`" >> q-analysis-report.md
        echo "" >> q-analysis-report.md
        
        echo "## ğŸ—ï¸ ë°°í¬ëœ ë¦¬ì†ŒìŠ¤" >> q-analysis-report.md
        terraform show -json | jq -r '.values.root_module.resources[] | "- \(.type): \(.name)"' >> q-analysis-report.md || echo "- ë¦¬ì†ŒìŠ¤ ëª©ë¡ ìƒì„± ì‹¤íŒ¨" >> q-analysis-report.md
        
    - name: ğŸ“¢ Q Analysis Notification
      uses: 8398a7/action-slack@v3
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      with:
        status: custom
        custom_payload: |
          {
            "channel": "${{ contains(github.event.head_commit.message, 'ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº”') && '#optimization' || '#infrastructure' }}",
            "username": "Amazon Q",
            "icon_emoji": "${{ contains(github.event.head_commit.message, 'ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº”') && ':mag:' || ':brain:' }}",
            "attachments": [
              {
                "color": "${{ contains(github.event.head_commit.message, 'ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº”') && '#ff9500' || 'good' }}",
                "title": "${{ contains(github.event.head_commit.message, 'ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº”') && 'ğŸ” AWS ë¦¬ì†ŒìŠ¤ ìµœì í™” ë¶„ì„ ì™„ë£Œ' || 'ğŸ¤– Q ìë™ ë¶„ì„ ë° ë°°í¬ ì™„ë£Œ' }}",
                "text": "${{ contains(github.event.head_commit.message, 'ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº”') && '```\nğŸ“Š ë¦¬ì†ŒìŠ¤ í˜„í™© ë¶„ì„\n- ì‹¤í–‰ ì¤‘ì¸ EC2: í™•ì¸ ì¤‘\n- ì¤‘ì§€ëœ EC2: í™•ì¸ ì¤‘  \n- ì—°ê²°ë˜ì§€ ì•Šì€ EBS: í™•ì¸ ì¤‘\n- ë³´ì•ˆ ê·¸ë£¹: í™•ì¸ ì¤‘\n\nğŸ’° ìµœì í™” ì œì•ˆ\n- ë¶ˆí•„ìš”í•œ ë¦¬ì†ŒìŠ¤ ì •ë¦¬ë¡œ ë¹„ìš© ì ˆì•½ ê°€ëŠ¥\n- ë³´ì•ˆ ê·¸ë£¹ ì •ë¦¬ë¡œ ê´€ë¦¬ íš¨ìœ¨ì„± í–¥ìƒ\n- ë¯¸ì‚¬ìš© EBS ë³¼ë¥¨ ì‚­ì œ ê¶Œì¥\n\nğŸ“ˆ ì˜ˆìƒ íš¨ê³¼\n- ì›” ë¹„ìš© ì ˆì•½: ë¶„ì„ ì¤‘\n- ë³´ì•ˆ í–¥ìƒ: ë¯¸ì‚¬ìš© ê·œì¹™ ì œê±°\n- ê´€ë¦¬ íš¨ìœ¨ì„±: ë¦¬ì†ŒìŠ¤ ì •ë¦¬\n```' || '' }}",
                "fields": [
                  {
                    "title": "${{ contains(github.event.head_commit.message, 'ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº”') && 'ğŸ¯ ë¶„ì„ ë²”ìœ„' || 'ğŸ§  ë¶„ì„ ë°©ì‹' }}",
                    "value": "${{ contains(github.event.head_commit.message, 'ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº”') && 'EC2, EBS, ë³´ì•ˆ ê·¸ë£¹, ë„¤íŠ¸ì›Œí¬' || 'Git ë³€ê²½ì‚¬í•­ ìë™ ê°ì§€' }}",
                    "short": true
                  },
                  {
                    "title": "${{ contains(github.event.head_commit.message, 'ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº”') && 'â±ï¸ ìŠ¤ìº” ì‹œê°„' || 'ğŸ“‹ ë³€ê²½ íŒŒì¼' }}",
                    "value": "${{ contains(github.event.head_commit.message, 'ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº”') && '1-2ë¶„ (AWS CLI)' || 'infrastructure-spec.yml' }}",
                    "short": true
                  },
                  {
                    "title": "${{ contains(github.event.head_commit.message, 'ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº”') && 'ğŸ” ë¶„ì„ ê²°ê³¼' || 'ğŸ’¬ ì»¤ë°‹' }}",
                    "value": "${{ contains(github.event.head_commit.message, 'ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº”') && 'ë¹„ìš© ìµœì í™” ê¸°íšŒ ë°œê²¬ - ìƒì„¸ ë‚´ìš©ì€ ìœ„ ì°¸ì¡°' || 'ì¸í”„ë¼ ë°°í¬ ì‹¤í–‰' }}",
                    "short": false
                  },
                  {
                    "title": "${{ contains(github.event.head_commit.message, 'ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº”') && 'ğŸ“Š ê¶Œì¥ ì¡°ì¹˜' || 'ğŸš€ ì‹¤í–‰ ê²°ê³¼' }}",
                    "value": "${{ contains(github.event.head_commit.message, 'ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº”') && 'ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ë° ë¹„ìš© ìµœì í™” ì‹¤í–‰' || 'âœ… ì„±ê³µì ìœ¼ë¡œ AWSì— ë°°í¬ë¨' }}",
                    "short": true
                  }
                ],
                "footer": "${{ contains(github.event.head_commit.message, 'ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº”') && 'Amazon Q Cost Optimization' || 'Amazon Q Auto Analysis System' }}"
              }
            ]
          }
          
    - name: ğŸ’¾ Upload Q Analysis Report
      uses: actions/upload-artifact@v4
      with:
        name: q-analysis-report
        path: infra/dev/terraform/q-analysis-report.md
        retention-days: 30
