name: ğŸ¤– Q Auto Analysis & Deploy

on:
  push:
    branches: [ develop ]
    paths:
      - 'infra/**'
      - 'infra/requirements/**'

env:
  AWS_REGION: 'ap-northeast-2'

jobs:
  q-analysis-deploy:
    name: ğŸ§  Q Analysis & Auto Deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # ì´ì „ ì»¤ë°‹ê³¼ ë¹„êµí•˜ê¸° ìœ„í•´
        
    - name: ğŸ” Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: âš™ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: '1.9.8'
        
    - name: ğŸ“‹ Get Changed Files
      id: changes
      run: |
        echo "changed_files<<EOF" >> $GITHUB_OUTPUT
        git diff --name-only HEAD~1 HEAD -- infra/ >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        echo "commit_message<<EOF" >> $GITHUB_OUTPUT
        git log -1 --pretty=%B >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: ğŸ§  Q Analysis & Deploy
      run: |
        echo "ğŸ¤– Qê°€ ì½”ë“œ ë³€ê²½ì‚¬í•­ì„ ë¶„ì„í•˜ê³  ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
        echo "ğŸ“‹ ë³€ê²½ëœ íŒŒì¼ë“¤: ${{ steps.changes.outputs.changed_files }}"
        echo "ğŸ’¬ ì»¤ë°‹ ë©”ì‹œì§€: ${{ steps.changes.outputs.commit_message }}"
        
        # ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº” ì²´í¬
        if echo "${{ steps.changes.outputs.commit_message }}" | grep -q "ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº”"; then
          echo "ğŸ” ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº” ì‹¤í–‰!"
          
          # AWS ë¦¬ì†ŒìŠ¤ ì¡°íšŒ
          echo "ğŸ“Š EC2 ì¡°íšŒ ì¤‘..."
          RUNNING_INSTANCES=$(aws ec2 describe-instances --region ap-northeast-2 --query 'Reservations[*].Instances[?State.Name==`running`]' --output json | jq length)
          STOPPED_INSTANCES=$(aws ec2 describe-instances --region ap-northeast-2 --query 'Reservations[*].Instances[?State.Name==`stopped`]' --output json | jq length)
          
          echo "ğŸ’¾ EBS ì¡°íšŒ ì¤‘..."
          UNATTACHED_VOLUMES=$(aws ec2 describe-volumes --region ap-northeast-2 --query 'Volumes[?State==`available`]' --output json | jq length)
          
          echo "ğŸ”’ ë³´ì•ˆ ê·¸ë£¹ ì¡°íšŒ ì¤‘..."
          TOTAL_SECURITY_GROUPS=$(aws ec2 describe-security-groups --region ap-northeast-2 --query 'SecurityGroups' --output json | jq length)
          
          # ë¹„ìš© ê³„ì‚°
          COST_SAVINGS=$(($UNATTACHED_VOLUMES * 8 + $STOPPED_INSTANCES * 20))
          
          echo "ğŸ“Š ë¶„ì„ ê²°ê³¼:"
          echo "- ì‹¤í–‰ ì¤‘ EC2: $RUNNING_INSTANCESê°œ"
          echo "- ì¤‘ì§€ëœ EC2: $STOPPED_INSTANCESê°œ" 
          echo "- ë¯¸ì‚¬ìš© EBS: $UNATTACHED_VOLUMESê°œ"
          echo "- ë³´ì•ˆ ê·¸ë£¹: $TOTAL_SECURITY_GROUPSê°œ"
          echo "- ì˜ˆìƒ ì ˆì•½: \$$COST_SAVINGS/ì›”"
          
          # Slack ë©”ì‹œì§€ íŒŒì¼ ìƒì„±
          echo "ğŸ“Š AWS ë¦¬ì†ŒìŠ¤ í˜„í™© ë¶„ì„" > slack_message.txt
          echo "" >> slack_message.txt
          echo "ğŸ–¥ï¸ EC2 ì¸ìŠ¤í„´ìŠ¤" >> slack_message.txt
          echo "- ì‹¤í–‰ ì¤‘: ${RUNNING_INSTANCES}ê°œ" >> slack_message.txt
          echo "- ì¤‘ì§€ë¨: ${STOPPED_INSTANCES}ê°œ" >> slack_message.txt
          echo "" >> slack_message.txt
          echo "ğŸ’¾ EBS ë³¼ë¥¨" >> slack_message.txt
          echo "- ë¯¸ì‚¬ìš©: ${UNATTACHED_VOLUMES}ê°œ" >> slack_message.txt
          echo "" >> slack_message.txt
          echo "ğŸ”’ ë³´ì•ˆ ê·¸ë£¹: ${TOTAL_SECURITY_GROUPS}ê°œ" >> slack_message.txt
          echo "" >> slack_message.txt
          echo "ğŸ’° ìµœì í™” ì œì•ˆ" >> slack_message.txt
          echo "- ì¤‘ì§€ëœ EC2 ì •ë¦¬: ì›” \$$(($STOPPED_INSTANCES * 20)) ì ˆì•½" >> slack_message.txt
          echo "- ë¯¸ì‚¬ìš© EBS ì‚­ì œ: ì›” \$$(($UNATTACHED_VOLUMES * 8)) ì ˆì•½" >> slack_message.txt
          echo "" >> slack_message.txt
          echo "ğŸ“ˆ ì´ ì˜ˆìƒ ì ˆì•½: \$${COST_SAVINGS}/ì›”" >> slack_message.txt
          
          echo "âœ… slack_message.txt íŒŒì¼ ìƒì„± ì™„ë£Œ"
          ls -la slack_message.txt
          cat slack_message.txt
          
          exit 0
        fi
        
        # ì¼ë°˜ ë°°í¬ ë¡œì§
        echo "ğŸš€ ì¼ë°˜ Terraform ë°°í¬ ì‹¤í–‰..."
        cd infra/dev/terraform
        terraform init
        terraform plan -out=tfplan
        terraform apply -auto-approve tfplan
        
    - name: ğŸ“Š Generate Q Analysis Report
      if: ${{ !contains(github.event.head_commit.message, 'ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº”') }}
      run: |
        cd infra/dev/terraform
        
        echo "# ğŸ¤– Q ìë™ ë¶„ì„ ë° ë°°í¬ ë¦¬í¬íŠ¸" > q-analysis-report.md
        echo "" >> q-analysis-report.md
        echo "**ë¶„ì„ ì‹œê°„**: $(date -u)" >> q-analysis-report.md
        echo "**íŠ¸ë¦¬ê±°**: Git Push (develop)" >> q-analysis-report.md
        echo "**ë¶„ì„ì**: Amazon Q" >> q-analysis-report.md
        echo "" >> q-analysis-report.md
        
        echo "## ğŸ“‹ ë³€ê²½ì‚¬í•­ ë¶„ì„" >> q-analysis-report.md
        echo "\`\`\`" >> q-analysis-report.md
        echo "${{ steps.changes.outputs.changed_files }}" >> q-analysis-report.md
        echo "\`\`\`" >> q-analysis-report.md
        echo "" >> q-analysis-report.md
        
        echo "## ğŸ’¬ ì»¤ë°‹ ë©”ì‹œì§€" >> q-analysis-report.md
        echo "\`\`\`" >> q-analysis-report.md
        echo "${{ steps.changes.outputs.commit_message }}" >> q-analysis-report.md
        echo "\`\`\`" >> q-analysis-report.md
        echo "" >> q-analysis-report.md
        
        echo "## ğŸ—ï¸ ë°°í¬ëœ ë¦¬ì†ŒìŠ¤" >> q-analysis-report.md
        terraform show -json | jq -r '.values.root_module.resources[] | "- \(.type): \(.name)"' >> q-analysis-report.md || echo "- ë¦¬ì†ŒìŠ¤ ëª©ë¡ ìƒì„± ì‹¤íŒ¨" >> q-analysis-report.md
        
    - name: ğŸ” Send Optimization Report to Slack
      if: ${{ contains(github.event.head_commit.message, 'ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº”') }}
      run: |
        if [ -f slack_message.txt ]; then
          echo "âœ… íŒŒì¼ ì¡´ì¬ - Slack ì „ì†¡ ì¤‘..."
          SLACK_MESSAGE=$(cat slack_message.txt | jq -Rs .)
          
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"channel\": \"#optimization\",
              \"username\": \"Amazon Q\",
              \"icon_emoji\": \":mag:\",
              \"text\": \"ğŸ” AWS ë¦¬ì†ŒìŠ¤ ìµœì í™” ë¶„ì„ ì™„ë£Œ\",
              \"attachments\": [{
                \"color\": \"#ff9500\",
                \"title\": \"ğŸ“Š ìƒì„¸ ë¶„ì„ ê²°ê³¼\",
                \"text\": ${SLACK_MESSAGE}
              }]
            }" \
            "${{ secrets.SLACK_WEBHOOK_URL }}"
          echo "âœ… Slack ì „ì†¡ ì™„ë£Œ"
        else
          echo "âŒ slack_message.txt íŒŒì¼ ì—†ìŒ"
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "channel": "#optimization",
              "username": "Amazon Q",
              "icon_emoji": ":warning:",
              "text": "âš ï¸ ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº” ì‹¤í–‰ë¨ (ê²°ê³¼ íŒŒì¼ ìƒì„± ì‹¤íŒ¨)"
            }' \
            "${{ secrets.SLACK_WEBHOOK_URL }}"
        fi

    - name: ğŸ“¢ Deploy Notification
      if: ${{ !contains(github.event.head_commit.message, 'ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº”') }}
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data '{
          "channel": "#infrastructure",
          "username": "Amazon Q",
          "icon_emoji": ":brain:",
          "text": "ğŸ¤– Q ìë™ ë°°í¬ ì™„ë£Œ",
          "attachments": [{
            "color": "good",
            "title": "ğŸš€ ì¸í”„ë¼ ë°°í¬ ì„±ê³µ",
            "fields": [{
              "title": "ğŸ’¬ ì»¤ë°‹",
              "value": "${{ github.event.head_commit.message }}",
              "short": false
            }]
          }]
        }' \
        ${{ secrets.SLACK_WEBHOOK_URL }}
          
    - name: ğŸ’¾ Upload Q Analysis Report
      if: ${{ !contains(github.event.head_commit.message, 'ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº”') }}
      uses: actions/upload-artifact@v4
      with:
        name: q-analysis-report
        path: infra/dev/terraform/q-analysis-report.md
        retention-days: 30
