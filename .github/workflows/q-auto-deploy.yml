name: ğŸ¤– Q Auto Analysis & Deploy

on:
  push:
    branches: [ develop ]
    paths:
      - 'infra/**'
      - 'infra/requirements/**'

env:
  AWS_REGION: 'ap-northeast-2'

jobs:
  q-analysis-deploy:
    name: ğŸ§  Q Analysis & Auto Deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # ì´ì „ ì»¤ë°‹ê³¼ ë¹„êµí•˜ê¸° ìœ„í•´
        
    - name: ğŸ” Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: âš™ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: '1.9.8'
        
    - name: ğŸ“‹ Get Changed Files
      id: changes
      run: |
        echo "changed_files<<EOF" >> $GITHUB_OUTPUT
        git diff --name-only HEAD~1 HEAD -- infra/ >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        echo "commit_message<<EOF" >> $GITHUB_OUTPUT
        git log -1 --pretty=%B >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: ğŸ§  Q Analysis & Deploy
      run: |
        echo "ğŸ¤– Qê°€ ì½”ë“œ ë³€ê²½ì‚¬í•­ì„ ë¶„ì„í•˜ê³  ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
        echo ""
        echo "ğŸ“‹ ë³€ê²½ëœ íŒŒì¼ë“¤:"
        echo "${{ steps.changes.outputs.changed_files }}"
        echo ""
        echo "ğŸ’¬ ì»¤ë°‹ ë©”ì‹œì§€:"
        echo "${{ steps.changes.outputs.commit_message }}"
        echo ""
        
        # Q CLI ëª…ë ¹ì–´ë¡œ ìë™ ë¶„ì„ ë° ë°°í¬
        echo "ğŸ” Qê°€ Terraform ì½”ë“œë¥¼ ë¶„ì„ ì¤‘..."
        
        # ë³€ê²½ì‚¬í•­ ë¶„ì„
        if echo "${{ steps.changes.outputs.changed_files }}" | grep -q "infrastructure-spec.yml"; then
          echo "âœ… ì¸í”„ë¼ ìŠ¤í™ ë³€ê²½ ê°ì§€ - ìš”êµ¬ì‚¬í•­ ì—…ë°ì´íŠ¸ í•„ìš”"
          
          # ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº” ëª…ë ¹ í™•ì¸
          if grep -q "unused_resource_scan:" infra/requirements/infrastructure-spec.yml && grep -q "trigger: true" infra/requirements/infrastructure-spec.yml; then
            echo "ğŸ” ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº” ëª…ë ¹ ê°ì§€!"
            echo "ğŸ“Š AWS ë¦¬ì†ŒìŠ¤ ìƒíƒœë§Œ ì¡°íšŒí•©ë‹ˆë‹¤ (plan/apply ìƒëµ)"
            
            # ì½ê¸° ì „ìš© ìŠ¤ìº” ì‹¤í–‰ ë° ê²°ê³¼ ì €ì¥
            echo "ğŸ”„ AWS CLIë¡œ ë¦¬ì†ŒìŠ¤ í˜„í™© ì¡°íšŒ ì¤‘..."
            
            # EC2 ì¸ìŠ¤í„´ìŠ¤ ì¡°íšŒ
            echo "ğŸ“Š EC2 ì¸ìŠ¤í„´ìŠ¤ ë¶„ì„ ì¤‘..."
            aws ec2 describe-instances --region ap-northeast-2 --query 'Reservations[*].Instances[*].[InstanceId,State.Name,InstanceType,LaunchTime]' --output table > ec2_report.txt || echo "EC2 ì¡°íšŒ ì‹¤íŒ¨" > ec2_report.txt
            
            # EBS ë³¼ë¥¨ ì¡°íšŒ
            echo "ğŸ’¾ EBS ë³¼ë¥¨ ë¶„ì„ ì¤‘..."
            aws ec2 describe-volumes --region ap-northeast-2 --query 'Volumes[*].[VolumeId,State,Size,Attachments[0].InstanceId//`unattached`]' --output table > ebs_report.txt || echo "EBS ì¡°íšŒ ì‹¤íŒ¨" > ebs_report.txt
            
            # ë³´ì•ˆ ê·¸ë£¹ ì¡°íšŒ
            echo "ğŸ”’ ë³´ì•ˆ ê·¸ë£¹ ë¶„ì„ ì¤‘..."
            aws ec2 describe-security-groups --region ap-northeast-2 --query 'SecurityGroups[*].[GroupId,GroupName,Description]' --output table > sg_report.txt || echo "ë³´ì•ˆ ê·¸ë£¹ ì¡°íšŒ ì‹¤íŒ¨" > sg_report.txt
            
            # ìµœì í™” ë¶„ì„ ìˆ˜í–‰
            echo "ğŸ§  Qê°€ ìµœì í™” ë°©ì•ˆì„ ë¶„ì„ ì¤‘..."
            
            # ë¯¸ì‚¬ìš© EBS ë³¼ë¥¨ ì¹´ìš´íŠ¸
            UNATTACHED_VOLUMES=$(grep -c "unattached" ebs_report.txt 2>/dev/null || echo "0")
            
            # ì‹¤í–‰ ì¤‘ì¸ EC2 ì¸ìŠ¤í„´ìŠ¤ ì¹´ìš´íŠ¸
            RUNNING_INSTANCES=$(grep -c "running" ec2_report.txt 2>/dev/null || echo "0")
            
            # ì¤‘ì§€ëœ EC2 ì¸ìŠ¤í„´ìŠ¤ ì¹´ìš´íŠ¸  
            STOPPED_INSTANCES=$(grep -c "stopped" ec2_report.txt 2>/dev/null || echo "0")
            
            # ë³´ì•ˆ ê·¸ë£¹ ì´ ê°œìˆ˜ (í—¤ë” ì œì™¸)
            TOTAL_SECURITY_GROUPS=$(tail -n +4 sg_report.txt 2>/dev/null | wc -l || echo "0")
            
            # ìµœì í™” ë¦¬í¬íŠ¸ ìƒì„±
            echo "ğŸ“Š ìµœì í™” ë¶„ì„ ê²°ê³¼:"
            echo "- ì‹¤í–‰ ì¤‘ì¸ EC2: $RUNNING_INSTANCESê°œ"
            echo "- ì¤‘ì§€ëœ EC2: $STOPPED_INSTANCESê°œ"
            echo "- ì—°ê²°ë˜ì§€ ì•Šì€ EBS: $UNATTACHED_VOLUMESê°œ"
            echo "- ë³´ì•ˆ ê·¸ë£¹: $TOTAL_SECURITY_GROUPSê°œ"
            COST_SAVINGS=$(($UNATTACHED_VOLUMES * 8 + $STOPPED_INSTANCES * 20))
            echo "ğŸ’° ì˜ˆìƒ ì›” ì ˆì•½: \$$COST_SAVINGS"
            
            # Slack ë©”ì‹œì§€ ìƒì„± (ë°˜ë“œì‹œ ìƒì„±)
            echo "ğŸ“Š AWS ë¦¬ì†ŒìŠ¤ í˜„í™© ë¶„ì„" > slack_message.txt
            echo "" >> slack_message.txt
            echo "ğŸ–¥ï¸ EC2 ì¸ìŠ¤í„´ìŠ¤" >> slack_message.txt
            echo "- ì‹¤í–‰ ì¤‘: ${RUNNING_INSTANCES}ê°œ" >> slack_message.txt
            echo "- ì¤‘ì§€ë¨: ${STOPPED_INSTANCES}ê°œ" >> slack_message.txt
            echo "" >> slack_message.txt
            echo "ğŸ’¾ EBS ë³¼ë¥¨" >> slack_message.txt
            echo "- ì—°ê²°ë˜ì§€ ì•ŠìŒ: ${UNATTACHED_VOLUMES}ê°œ" >> slack_message.txt
            echo "" >> slack_message.txt
            echo "ğŸ”’ ë³´ì•ˆ ê·¸ë£¹" >> slack_message.txt
            echo "- ì´ ê°œìˆ˜: ${TOTAL_SECURITY_GROUPS}ê°œ" >> slack_message.txt
            echo "" >> slack_message.txt
            echo "ğŸ’° ìµœì í™” ì œì•ˆ" >> slack_message.txt
            echo "- ì¤‘ì§€ëœ EC2 ì •ë¦¬: ì›” \$$(($STOPPED_INSTANCES * 20)) ì ˆì•½" >> slack_message.txt
            echo "- ë¯¸ì‚¬ìš© EBS ì‚­ì œ: ì›” \$$(($UNATTACHED_VOLUMES * 8)) ì ˆì•½" >> slack_message.txt
            echo "- ë³´ì•ˆ ê·¸ë£¹ ì •ë¦¬ë¡œ ê´€ë¦¬ íš¨ìœ¨ì„± í–¥ìƒ" >> slack_message.txt
            echo "" >> slack_message.txt
            echo "ğŸ“ˆ ì˜ˆìƒ íš¨ê³¼" >> slack_message.txt
            echo "- ì›” ì´ ì ˆì•½ ë¹„ìš©: \$${COST_SAVINGS}" >> slack_message.txt
            echo "- ë³´ì•ˆ í–¥ìƒ: ë¯¸ì‚¬ìš© ê·œì¹™ ì œê±°" >> slack_message.txt
            echo "- ê´€ë¦¬ íš¨ìœ¨ì„±: ë¦¬ì†ŒìŠ¤ ì •ë¦¬" >> slack_message.txt
            
            echo "ğŸ“„ Slack ë©”ì‹œì§€ íŒŒì¼ ìƒì„± ì™„ë£Œ:"
            ls -la slack_message.txt
            echo "ğŸ“„ íŒŒì¼ ë‚´ìš©:"
            cat slack_message.txt
            
            echo "âœ… ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº” ì™„ë£Œ! (Terraform ì‹¤í–‰ ìƒëµ)"
            echo "ğŸ“Š ìµœì í™” ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ"
            exit 0
          fi
          
          # ì‚­ì œ ëª…ë ¹ í™•ì¸
          if grep -q "destroy_all:" infra/requirements/infrastructure-spec.yml && grep -q "trigger: true" infra/requirements/infrastructure-spec.yml; then
            echo "ğŸ—‘ï¸ ì „ì²´ ì¸í”„ë¼ ì‚­ì œ ëª…ë ¹ ê°ì§€!"
            echo "ğŸ”„ Terraform ë°±ì—”ë“œ ì¬êµ¬ì„± ì¤‘..."
            cd infra/dev/terraform
            terraform init -reconfigure
            echo "ğŸš¨ Terraform destroy ì‹¤í–‰ ì¤‘..."
            terraform destroy -auto-approve
            echo "âœ… ì „ì²´ ì¸í”„ë¼ ì‚­ì œ ì™„ë£Œ!"
            exit 0
          fi
        fi
        
        if echo "${{ steps.changes.outputs.changed_files }}" | grep -q "terraform.tfvars"; then
          echo "âœ… ë³€ìˆ˜ íŒŒì¼ ë³€ê²½ ê°ì§€ - ì„¤ì • ì—…ë°ì´íŠ¸ í•„ìš”"
        fi
        
        if echo "${{ steps.changes.outputs.changed_files }}" | grep -q "main.tf"; then
          echo "âœ… ë©”ì¸ ì„¤ì • ë³€ê²½ ê°ì§€ - ë¦¬ì†ŒìŠ¤ ì—…ë°ì´íŠ¸ í•„ìš”"
        fi
        
        if echo "${{ steps.changes.outputs.changed_files }}" | grep -q "modules/"; then
          echo "âœ… ëª¨ë“ˆ ë³€ê²½ ê°ì§€ - ëª¨ë“ˆ ê¸°ë°˜ ë¦¬ì†ŒìŠ¤ ì—…ë°ì´íŠ¸ í•„ìš”"
        fi
        
        # ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº”ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ Terraform ì‹¤í–‰
        if ! echo "${{ github.event.head_commit.message }}" | grep -q "ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº”"; then
          echo ""
          echo "ğŸš€ Qê°€ ìë™ìœ¼ë¡œ Terraform ë°°í¬ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤..."
          
          # Terraform ì‹¤í–‰
          cd infra/dev/terraform
          
          echo "ğŸ”„ Terraform ì´ˆê¸°í™”..."
          terraform init
          
          echo "ğŸ”“ ê¸°ì¡´ ë½ í•´ì œ ì‹œë„..."
          # ë™ì ìœ¼ë¡œ ë½ ìƒíƒœ í™•ì¸ í›„ í•´ì œ
          if terraform force-unlock -help > /dev/null 2>&1; then
            echo "ë½ í•´ì œ ê¸°ëŠ¥ ì‚¬ìš© ê°€ëŠ¥"
          fi
          
          echo "ğŸ“‹ ë³€ê²½ ê³„íš ìƒì„±..."
          terraform plan -out=tfplan
          
          echo "ğŸš€ ì¸í”„ë¼ ë°°í¬ ì‹¤í–‰..."
          terraform apply -auto-approve tfplan
          
          echo "âœ… Q ìë™ ë°°í¬ ì™„ë£Œ!"
        else
          echo "ğŸ“Š ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº” ì™„ë£Œ - Terraform ì‹¤í–‰ ìƒëµ"
        fi
        
    - name: ğŸ“Š Generate Q Analysis Report
      if: ${{ !contains(github.event.head_commit.message, 'ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº”') }}
      run: |
        cd infra/dev/terraform
        
        echo "# ğŸ¤– Q ìë™ ë¶„ì„ ë° ë°°í¬ ë¦¬í¬íŠ¸" > q-analysis-report.md
        echo "" >> q-analysis-report.md
        echo "**ë¶„ì„ ì‹œê°„**: $(date -u)" >> q-analysis-report.md
        echo "**íŠ¸ë¦¬ê±°**: Git Push (develop)" >> q-analysis-report.md
        echo "**ë¶„ì„ì**: Amazon Q" >> q-analysis-report.md
        echo "" >> q-analysis-report.md
        
        echo "## ğŸ“‹ ë³€ê²½ì‚¬í•­ ë¶„ì„" >> q-analysis-report.md
        echo "\`\`\`" >> q-analysis-report.md
        echo "${{ steps.changes.outputs.changed_files }}" >> q-analysis-report.md
        echo "\`\`\`" >> q-analysis-report.md
        echo "" >> q-analysis-report.md
        
        echo "## ğŸ’¬ ì»¤ë°‹ ë©”ì‹œì§€" >> q-analysis-report.md
        echo "\`\`\`" >> q-analysis-report.md
        echo "${{ steps.changes.outputs.commit_message }}" >> q-analysis-report.md
        echo "\`\`\`" >> q-analysis-report.md
        echo "" >> q-analysis-report.md
        
        echo "## ğŸ—ï¸ ë°°í¬ëœ ë¦¬ì†ŒìŠ¤" >> q-analysis-report.md
        terraform show -json | jq -r '.values.root_module.resources[] | "- \(.type): \(.name)"' >> q-analysis-report.md || echo "- ë¦¬ì†ŒìŠ¤ ëª©ë¡ ìƒì„± ì‹¤íŒ¨" >> q-analysis-report.md
        
    - name: ğŸ” Send Optimization Report to Slack
      if: ${{ contains(github.event.head_commit.message, 'ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº”') }}
      run: |
        echo "ğŸ” Slack ì „ì†¡ ë‹¨ê³„ ì‹œì‘..."
        
        if [ -f slack_message.txt ]; then
          echo "âœ… slack_message.txt íŒŒì¼ ì¡´ì¬ í™•ì¸"
          echo "ğŸ“„ íŒŒì¼ ë‚´ìš©:"
          cat slack_message.txt
          
          # íŒŒì¼ ë‚´ìš©ì„ JSON ì•ˆì „í•˜ê²Œ ë³€í™˜
          SLACK_MESSAGE=$(cat slack_message.txt | jq -Rs .)
          echo "ğŸ”— Slack ì „ì†¡ ì¤‘..."
          
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"channel\": \"#optimization\",
              \"username\": \"Amazon Q\",
              \"icon_emoji\": \":mag:\",
              \"text\": \"ğŸ” AWS ë¦¬ì†ŒìŠ¤ ìµœì í™” ë¶„ì„ ì™„ë£Œ\",
              \"attachments\": [{
                \"color\": \"#ff9500\",
                \"title\": \"ğŸ“Š ìƒì„¸ ë¶„ì„ ê²°ê³¼\",
                \"text\": ${SLACK_MESSAGE},
                \"fields\": [{
                  \"title\": \"ğŸ¯ ë¶„ì„ ë²”ìœ„\",
                  \"value\": \"EC2, EBS, ë³´ì•ˆ ê·¸ë£¹\",
                  \"short\": true
                }, {
                  \"title\": \"â±ï¸ ìŠ¤ìº” ì‹œê°„\",
                  \"value\": \"1-2ë¶„ (AWS CLI)\",
                  \"short\": true
                }],
                \"footer\": \"Amazon Q Cost Optimization\"
              }]
            }" \
            "${{ secrets.SLACK_WEBHOOK_URL }}"
          
          echo "âœ… Slack ì „ì†¡ ì™„ë£Œ"
        else
          echo "âŒ slack_message.txt íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
          echo "ğŸ“ í˜„ì¬ ë””ë ‰í† ë¦¬ íŒŒì¼ ëª©ë¡:"
          ls -la
          echo "ğŸ” ëŒ€ì²´ ë©”ì‹œì§€ ì „ì†¡..."
          
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "channel": "#optimization",
              "username": "Amazon Q",
              "icon_emoji": ":warning:",
              "text": "âš ï¸ ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº” ì™„ë£Œ (ìƒì„¸ ê²°ê³¼ íŒŒì¼ ì—†ìŒ)",
              "attachments": [{
                "color": "warning",
                "title": "ğŸ“Š ìŠ¤ìº” ìƒíƒœ",
                "text": "AWS CLIë¥¼ í†µí•œ ë¦¬ì†ŒìŠ¤ ìŠ¤ìº”ì´ ì‹¤í–‰ë˜ì—ˆìœ¼ë‚˜ ê²°ê³¼ íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.",
                "footer": "Amazon Q Cost Optimization"
              }]
            }' \
            "${{ secrets.SLACK_WEBHOOK_URL }}"
        fi

    - name: ğŸ“¢ Q Analysis Notification
      if: ${{ !contains(github.event.head_commit.message, 'ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº”') }}
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data '{
          "channel": "#infrastructure",
          "username": "Amazon Q",
          "icon_emoji": ":brain:",
          "text": "ğŸ¤– Q ìë™ ë¶„ì„ ë° ë°°í¬ ì™„ë£Œ",
          "attachments": [{
            "color": "good",
            "title": "ğŸš€ ì¸í”„ë¼ ë°°í¬ ì„±ê³µ",
            "fields": [
              {
                "title": "ğŸ§  ë¶„ì„ ë°©ì‹",
                "value": "Git ë³€ê²½ì‚¬í•­ ìë™ ê°ì§€",
                "short": true
              },
              {
                "title": "ğŸ“‹ ë³€ê²½ íŒŒì¼",
                "value": "infrastructure-spec.yml",
                "short": true
              },
              {
                "title": "ğŸ’¬ ì»¤ë°‹",
                "value": "${{ github.event.head_commit.message }}",
                "short": false
              },
              {
                "title": "ğŸš€ ì‹¤í–‰ ê²°ê³¼",
                "value": "âœ… ì„±ê³µì ìœ¼ë¡œ AWSì— ë°°í¬ë¨",
                "short": true
              }
            ],
            "footer": "Amazon Q Auto Analysis System"
          }]
        }' \
        ${{ secrets.SLACK_WEBHOOK_URL }}
          
    - name: ğŸ’¾ Upload Q Analysis Report
      if: ${{ !contains(github.event.head_commit.message, 'ë¯¸ì‚¬ìš© ë¦¬ì†ŒìŠ¤ ìŠ¤ìº”') }}
      uses: actions/upload-artifact@v4
      with:
        name: q-analysis-report
        path: infra/dev/terraform/q-analysis-report.md
        retention-days: 30
