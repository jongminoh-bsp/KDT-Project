name: ğŸ¤– Q Auto Analysis & Deploy

on:
  push:
    branches: [ develop ]
    paths:
      - 'infra/**'
      - 'infra/requirements/**'

env:
  AWS_REGION: 'ap-northeast-2'

jobs:
  q-analysis-deploy:
    name: ğŸ§  Q Analysis & Auto Deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # ì´ì „ ì»¤ë°‹ê³¼ ë¹„êµí•˜ê¸° ìœ„í•´
        
    - name: ğŸ” Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: âš™ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: '1.9.8'
        
    - name: ğŸ“‹ Get Changed Files
      id: changes
      run: |
        echo "changed_files<<EOF" >> $GITHUB_OUTPUT
        git diff --name-only HEAD~1 HEAD -- infra/ >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        echo "commit_message<<EOF" >> $GITHUB_OUTPUT
        git log -1 --pretty=%B >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: ğŸ§  Q Analysis & Deploy
      run: |
        echo "ğŸ¤– Qê°€ ì½”ë“œ ë³€ê²½ì‚¬í•­ì„ ë¶„ì„í•˜ê³  ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
        echo ""
        echo "ğŸ“‹ ë³€ê²½ëœ íŒŒì¼ë“¤:"
        echo "${{ steps.changes.outputs.changed_files }}"
        echo ""
        echo "ğŸ’¬ ì»¤ë°‹ ë©”ì‹œì§€:"
        echo "${{ steps.changes.outputs.commit_message }}"
        echo ""
        
        # Q CLI ëª…ë ¹ì–´ë¡œ ìë™ ë¶„ì„ ë° ë°°í¬
        echo "ğŸ” Qê°€ Terraform ì½”ë“œë¥¼ ë¶„ì„ ì¤‘..."
        
        # ë³€ê²½ì‚¬í•­ ë¶„ì„
        if echo "${{ steps.changes.outputs.changed_files }}" | grep -q "infrastructure-spec.yml"; then
          echo "âœ… ì¸í”„ë¼ ìŠ¤í™ ë³€ê²½ ê°ì§€ - ìš”êµ¬ì‚¬í•­ ì—…ë°ì´íŠ¸ í•„ìš”"
        fi
        
        if echo "${{ steps.changes.outputs.changed_files }}" | grep -q "terraform.tfvars"; then
          echo "âœ… ë³€ìˆ˜ íŒŒì¼ ë³€ê²½ ê°ì§€ - ì„¤ì • ì—…ë°ì´íŠ¸ í•„ìš”"
        fi
        
        if echo "${{ steps.changes.outputs.changed_files }}" | grep -q "main.tf"; then
          echo "âœ… ë©”ì¸ ì„¤ì • ë³€ê²½ ê°ì§€ - ë¦¬ì†ŒìŠ¤ ì—…ë°ì´íŠ¸ í•„ìš”"
        fi
        
        if echo "${{ steps.changes.outputs.changed_files }}" | grep -q "modules/"; then
          echo "âœ… ëª¨ë“ˆ ë³€ê²½ ê°ì§€ - ëª¨ë“ˆ ê¸°ë°˜ ë¦¬ì†ŒìŠ¤ ì—…ë°ì´íŠ¸ í•„ìš”"
        fi
        
        echo ""
        echo "ğŸš€ Qê°€ ìë™ìœ¼ë¡œ Terraform ë°°í¬ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤..."
        
        # Terraform ì‹¤í–‰
        cd infra/dev/terraform
        
        echo "ğŸ”„ Terraform ì´ˆê¸°í™”..."
        terraform init
        
        echo "ğŸ“‹ ë³€ê²½ ê³„íš ìƒì„±..."
        terraform plan -out=tfplan
        
        echo "ğŸš€ ì¸í”„ë¼ ë°°í¬ ì‹¤í–‰..."
        terraform apply -auto-approve tfplan
        
        echo "âœ… Q ìë™ ë°°í¬ ì™„ë£Œ!"
        
    - name: ğŸ“Š Generate Q Analysis Report
      run: |
        cd infra/dev/terraform
        
        echo "# ğŸ¤– Q ìë™ ë¶„ì„ ë° ë°°í¬ ë¦¬í¬íŠ¸" > q-analysis-report.md
        echo "" >> q-analysis-report.md
        echo "**ë¶„ì„ ì‹œê°„**: $(date -u)" >> q-analysis-report.md
        echo "**íŠ¸ë¦¬ê±°**: Git Push (develop)" >> q-analysis-report.md
        echo "**ë¶„ì„ì**: Amazon Q" >> q-analysis-report.md
        echo "" >> q-analysis-report.md
        
        echo "## ğŸ“‹ ë³€ê²½ì‚¬í•­ ë¶„ì„" >> q-analysis-report.md
        echo "\`\`\`" >> q-analysis-report.md
        echo "${{ steps.changes.outputs.changed_files }}" >> q-analysis-report.md
        echo "\`\`\`" >> q-analysis-report.md
        echo "" >> q-analysis-report.md
        
        echo "## ğŸ’¬ ì»¤ë°‹ ë©”ì‹œì§€" >> q-analysis-report.md
        echo "\`\`\`" >> q-analysis-report.md
        echo "${{ steps.changes.outputs.commit_message }}" >> q-analysis-report.md
        echo "\`\`\`" >> q-analysis-report.md
        echo "" >> q-analysis-report.md
        
        echo "## ğŸ—ï¸ ë°°í¬ëœ ë¦¬ì†ŒìŠ¤" >> q-analysis-report.md
        terraform show -json | jq -r '.values.root_module.resources[] | "- \(.type): \(.name)"' >> q-analysis-report.md || echo "- ë¦¬ì†ŒìŠ¤ ëª©ë¡ ìƒì„± ì‹¤íŒ¨" >> q-analysis-report.md
        
    - name: ğŸ“¢ Q Analysis Notification
      uses: 8398a7/action-slack@v3
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      with:
        status: custom
        custom_payload: |
          {
            "channel": "#infrastructure",
            "username": "Amazon Q",
            "icon_emoji": ":brain:",
            "attachments": [
              {
                "color": "good",
                "title": "ğŸ¤– Q ìë™ ë¶„ì„ ë° ë°°í¬ ì™„ë£Œ",
                "fields": [
                  {
                    "title": "ğŸ§  ë¶„ì„ ë°©ì‹",
                    "value": "Git ë³€ê²½ì‚¬í•­ ìë™ ê°ì§€",
                    "short": true
                  },
                  {
                    "title": "ğŸ“‹ ë³€ê²½ íŒŒì¼",
                    "value": "${{ steps.changes.outputs.changed_files }}",
                    "short": true
                  },
                  {
                    "title": "ğŸ’¬ ì»¤ë°‹",
                    "value": "${{ github.event.head_commit.id }}",
                    "short": false
                  },
                  {
                    "title": "ğŸš€ ë°°í¬ ê²°ê³¼",
                    "value": "âœ… ì„±ê³µì ìœ¼ë¡œ AWSì— ë°°í¬ë¨",
                    "short": true
                  }
                ],
                "footer": "Amazon Q Auto Analysis System"
              }
            ]
          }
          
    - name: ğŸ’¾ Upload Q Analysis Report
      uses: actions/upload-artifact@v4
      with:
        name: q-analysis-report
        path: infra/dev/terraform/q-analysis-report.md
        retention-days: 30
