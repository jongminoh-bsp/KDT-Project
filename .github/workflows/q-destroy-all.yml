name: ğŸ—‘ï¸ Q Infrastructure Destroy All

on:
  workflow_dispatch:
    inputs:
      confirm_destroy:
        description: 'ì •ë§ë¡œ ëª¨ë“  ì¸í”„ë¼ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (yes/no)'
        required: true
        default: 'no'
        type: choice
        options:
        - 'no'
        - 'yes'

env:
  AWS_REGION: 'ap-northeast-2'

jobs:
  destroy-all:
    name: ğŸ—‘ï¸ Destroy All Infrastructure
    if: github.event.inputs.confirm_destroy == 'yes'
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ” Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: âš™ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: '1.9.8'
        
    - name: ğŸ”„ Terraform Init
      run: |
        cd infra/dev/terraform
        terraform init
        
    - name: ğŸ—‘ï¸ Terraform Destroy
      run: |
        cd infra/dev/terraform
        echo "ğŸ—‘ï¸ Qê°€ ì „ì²´ ì¸í”„ë¼ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤..."
        terraform destroy -auto-approve
        
    - name: ğŸ“¢ Destroy Notification
      uses: 8398a7/action-slack@v3
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      with:
        status: custom
        custom_payload: |
          {
            "channel": "#infrastructure",
            "username": "Amazon Q",
            "icon_emoji": ":wastebasket:",
            "attachments": [
              {
                "color": "warning",
                "title": "ğŸ—‘ï¸ ì „ì²´ ì¸í”„ë¼ ì‚­ì œ ì™„ë£Œ",
                "fields": [
                  {
                    "title": "ğŸ§  ì‹¤í–‰ì",
                    "value": "Amazon Q Auto System",
                    "short": true
                  },
                  {
                    "title": "ğŸŒ ë¦¬ì „",
                    "value": "${{ env.AWS_REGION }}",
                    "short": true
                  },
                  {
                    "title": "ğŸ—‘ï¸ ì‚­ì œ ë²”ìœ„",
                    "value": "ëª¨ë“  AWS ë¦¬ì†ŒìŠ¤",
                    "short": false
                  },
                  {
                    "title": "âœ… ìƒíƒœ",
                    "value": "ì‚­ì œ ì™„ë£Œ - ê¹¨ë—í•œ ìƒíƒœ",
                    "short": true
                  }
                ],
                "footer": "Amazon Q Infrastructure Management"
              }
            ]
          }
