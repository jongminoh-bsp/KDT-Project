name: ğŸ¤– Slack Bot API

on:
  repository_dispatch:
    types: [slack-command]

env:
  AWS_REGION: 'ap-northeast-2'

jobs:
  slack-bot:
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ” Configure AWS
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: ğŸ¤– Process Slack Command
      run: |
        COMMAND="${{ github.event.client_payload.command }}"
        CHANNEL="${{ github.event.client_payload.channel }}"
        USER="${{ github.event.client_payload.user }}"
        
        echo "ğŸ“ ë°›ì€ ëª…ë ¹: $COMMAND"
        echo "ğŸ“± ì±„ë„: $CHANNEL"
        echo "ğŸ‘¤ ì‚¬ìš©ì: $USER"
        
        # ì‹¤ì‹œê°„ ì‘ë‹µ ì‹œì‘
        curl -X POST -H 'Content-type: application/json' \
        --data "{
          \"channel\": \"$CHANNEL\",
          \"username\": \"Amazon Q\",
          \"icon_emoji\": \":robot_face:\",
          \"text\": \"ğŸ¤– $USERë‹˜ì˜ ìš”ì²­ì„ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤... \`$COMMAND\`\"
        }" \
        "${{ secrets.SLACK_WEBHOOK_URL }}"
        
        case "$COMMAND" in
          *"ë¦¬ì†ŒìŠ¤ í˜„í™©"*|*"resource status"*)
            echo "ğŸ“Š AWS ë¦¬ì†ŒìŠ¤ í˜„í™© ì¡°íšŒ ì¤‘..."
            
            # ë¦¬ì†ŒìŠ¤ ì¡°íšŒ
            EC2_RUNNING=$(aws ec2 describe-instances --region ap-northeast-2 --query 'Reservations[*].Instances[?State.Name==`running`]' --output json | jq length)
            EC2_STOPPED=$(aws ec2 describe-instances --region ap-northeast-2 --query 'Reservations[*].Instances[?State.Name==`stopped`]' --output json | jq length)
            EBS_UNATTACHED=$(aws ec2 describe-volumes --region ap-northeast-2 --query 'Volumes[?State==`available`]' --output json | jq length)
            VPC_COUNT=$(aws ec2 describe-vpcs --region ap-northeast-2 --query 'Vpcs' --output json | jq length)
            RDS_COUNT=$(aws rds describe-db-instances --region ap-northeast-2 --query 'DBInstances' --output json | jq length)
            EKS_COUNT=$(aws eks list-clusters --region ap-northeast-2 --query 'clusters' --output json | jq length)
            
            curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"channel\": \"$CHANNEL\",
              \"username\": \"Amazon Q\",
              \"icon_emoji\": \":bar_chart:\",
              \"text\": \"ğŸ“Š ì‹¤ì‹œê°„ AWS ë¦¬ì†ŒìŠ¤ í˜„í™©\",
              \"attachments\": [{
                \"color\": \"good\",
                \"fields\": [
                  {\"title\": \"ğŸ–¥ï¸ EC2 ì‹¤í–‰ì¤‘\", \"value\": \"${EC2_RUNNING}ê°œ\", \"short\": true},
                  {\"title\": \"â¹ï¸ EC2 ì¤‘ì§€ë¨\", \"value\": \"${EC2_STOPPED}ê°œ\", \"short\": true},
                  {\"title\": \"ğŸ’¾ ë¯¸ì‚¬ìš© EBS\", \"value\": \"${EBS_UNATTACHED}ê°œ\", \"short\": true},
                  {\"title\": \"ğŸŒ VPC\", \"value\": \"${VPC_COUNT}ê°œ\", \"short\": true},
                  {\"title\": \"ğŸ—„ï¸ RDS\", \"value\": \"${RDS_COUNT}ê°œ\", \"short\": true},
                  {\"title\": \"â˜¸ï¸ EKS\", \"value\": \"${EKS_COUNT}ê°œ\", \"short\": true}
                ]
              }]
            }" \
            "${{ secrets.SLACK_WEBHOOK_URL }}"
            ;;
            
          *"ë¹„ìš© ë¶„ì„"*|*"cost analysis"*)
            echo "ğŸ’° ë¹„ìš© ë¶„ì„ ì¤‘..."
            
            EC2_STOPPED=$(aws ec2 describe-instances --region ap-northeast-2 --query 'Reservations[*].Instances[?State.Name==`stopped`]' --output json | jq length)
            EBS_UNATTACHED=$(aws ec2 describe-volumes --region ap-northeast-2 --query 'Volumes[?State==`available`]' --output json | jq length)
            COST_SAVINGS=$(($EBS_UNATTACHED * 8 + $EC2_STOPPED * 20))
            
            curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"channel\": \"$CHANNEL\",
              \"username\": \"Amazon Q\",
              \"icon_emoji\": \":moneybag:\",
              \"text\": \"ğŸ’° ì‹¤ì‹œê°„ ë¹„ìš© ìµœì í™” ë¶„ì„\",
              \"attachments\": [{
                \"color\": \"warning\",
                \"fields\": [
                  {\"title\": \"â¹ï¸ ì¤‘ì§€ëœ EC2\", \"value\": \"${EC2_STOPPED}ê°œ â†’ ì›” \$$(($EC2_STOPPED * 20)) ì ˆì•½ ê°€ëŠ¥\", \"short\": false},
                  {\"title\": \"ğŸ’¾ ë¯¸ì‚¬ìš© EBS\", \"value\": \"${EBS_UNATTACHED}ê°œ â†’ ì›” \$$(($EBS_UNATTACHED * 8)) ì ˆì•½ ê°€ëŠ¥\", \"short\": false},
                  {\"title\": \"ğŸ’µ ì´ ì ˆì•½ ê°€ëŠ¥\", \"value\": \"ì›” \$${COST_SAVINGS}\", \"short\": true}
                ]
              }]
            }" \
            "${{ secrets.SLACK_WEBHOOK_URL }}"
            ;;
            
          *"ë³´ì•ˆ ì ê²€"*|*"security check"*)
            echo "ğŸ”’ ë³´ì•ˆ ì ê²€ ì¤‘..."
            
            SG_COUNT=$(aws ec2 describe-security-groups --region ap-northeast-2 --query 'SecurityGroups' --output json | jq length)
            OPEN_SG=$(aws ec2 describe-security-groups --region ap-northeast-2 --query 'SecurityGroups[?IpPermissions[?IpRanges[?CidrIp==`0.0.0.0/0`]]]' --output json | jq length)
            IAM_USERS=$(aws iam list-users --query 'Users' --output json | jq length)
            
            curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"channel\": \"$CHANNEL\",
              \"username\": \"Amazon Q\",
              \"icon_emoji\": \":shield:\",
              \"text\": \"ğŸ”’ ì‹¤ì‹œê°„ ë³´ì•ˆ ì ê²€ ê²°ê³¼\",
              \"attachments\": [{
                \"color\": \"${OPEN_SG -gt 0 && 'danger' || 'good'}\",
                \"fields\": [
                  {\"title\": \"ğŸ”’ ë³´ì•ˆ ê·¸ë£¹\", \"value\": \"${SG_COUNT}ê°œ\", \"short\": true},
                  {\"title\": \"âš ï¸ ì „ì²´ ì˜¤í”ˆ SG\", \"value\": \"${OPEN_SG}ê°œ\", \"short\": true},
                  {\"title\": \"ğŸ‘¤ IAM ì‚¬ìš©ì\", \"value\": \"${IAM_USERS}ê°œ\", \"short\": true}
                ]
              }]
            }" \
            "${{ secrets.SLACK_WEBHOOK_URL }}"
            ;;
            
          *"ë„ì›€ë§"*|*"help"*)
            curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"channel\": \"$CHANNEL\",
              \"username\": \"Amazon Q\",
              \"icon_emoji\": \":question:\",
              \"text\": \"ğŸ¤– Amazon Q ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´\",
              \"attachments\": [{
                \"color\": \"#36a64f\",
                \"fields\": [
                  {\"title\": \"ğŸ“Š ë¦¬ì†ŒìŠ¤ í˜„í™©\", \"value\": \"AWS ë¦¬ì†ŒìŠ¤ ì‹¤ì‹œê°„ ì¡°íšŒ\", \"short\": true},
                  {\"title\": \"ğŸ’° ë¹„ìš© ë¶„ì„\", \"value\": \"ë¹„ìš© ìµœì í™” ë¶„ì„\", \"short\": true},
                  {\"title\": \"ğŸ”’ ë³´ì•ˆ ì ê²€\", \"value\": \"ë³´ì•ˆ ìƒíƒœ ì ê²€\", \"short\": true},
                  {\"title\": \"ğŸ†˜ ë„ì›€ë§\", \"value\": \"ì´ ë©”ì‹œì§€ í‘œì‹œ\", \"short\": true}
                ]
              }]
            }" \
            "${{ secrets.SLACK_WEBHOOK_URL }}"
            ;;
            
          *)
            curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"channel\": \"$CHANNEL\",
              \"username\": \"Amazon Q\",
              \"icon_emoji\": \":thinking_face:\",
              \"text\": \"ğŸ¤” ì£„ì†¡í•´ìš”, '\`$COMMAND\`' ëª…ë ¹ì„ ì´í•´í•˜ì§€ ëª»í–ˆì–´ìš”. \`ë„ì›€ë§\`ì„ ì…ë ¥í•´ë³´ì„¸ìš”!\"
            }" \
            "${{ secrets.SLACK_WEBHOOK_URL }}"
            ;;
        esac
