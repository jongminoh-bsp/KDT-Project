name: ğŸ—ï¸ Terraform Slack Notifications

on:
  workflow_run:
    workflows: ["ğŸ¤– Q Auto Analysis & Deploy", "ğŸ—ï¸ Terraform Deploy"]
    types: [requested, in_progress, completed]

jobs:
  terraform-notify:
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ”„ Workflow Started
      if: github.event.workflow_run.status == 'requested' || github.event.workflow_run.status == 'in_progress'
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data '{
          "channel": "#infrastructure",
          "username": "Terraform Bot",
          "icon_emoji": ":gear:",
          "text": "ğŸ”„ Terraform ë°°í¬ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤...",
          "attachments": [{
            "color": "warning",
            "title": "ğŸ—ï¸ ì¸í”„ë¼ ë°°í¬ ì§„í–‰ ì¤‘",
            "fields": [
              {
                "title": "ğŸ“‹ ì›Œí¬í”Œë¡œìš°",
                "value": "${{ github.event.workflow_run.name }}",
                "short": true
              },
              {
                "title": "ğŸŒ¿ ë¸Œëœì¹˜",
                "value": "${{ github.event.workflow_run.head_branch }}",
                "short": true
              },
              {
                "title": "ğŸ‘¤ íŠ¸ë¦¬ê±°",
                "value": "${{ github.event.workflow_run.actor.login }}",
                "short": true
              },
              {
                "title": "â° ì‹œì‘ ì‹œê°„",
                "value": "${{ github.event.workflow_run.created_at }}",
                "short": true
              },
              {
                "title": "ğŸ”— ë§í¬",
                "value": "<${{ github.event.workflow_run.html_url }}|ì›Œí¬í”Œë¡œìš° ë³´ê¸°>",
                "short": false
              }
            ],
            "footer": "KDT Terraform Pipeline"
          }]
        }' \
        ${{ secrets.SLACK_WEBHOOK_URL }}
        
    - name: âœ… Workflow Success
      if: github.event.workflow_run.status == 'completed' && github.event.workflow_run.conclusion == 'success'
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data '{
          "channel": "#infrastructure",
          "username": "Terraform Bot",
          "icon_emoji": ":white_check_mark:",
          "text": "âœ… Terraform ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!",
          "attachments": [{
            "color": "good",
            "title": "ğŸ‰ ì¸í”„ë¼ ë°°í¬ ì„±ê³µ",
            "fields": [
              {
                "title": "ğŸ“‹ ì›Œí¬í”Œë¡œìš°",
                "value": "${{ github.event.workflow_run.name }}",
                "short": true
              },
              {
                "title": "ğŸŒ¿ ë¸Œëœì¹˜",
                "value": "${{ github.event.workflow_run.head_branch }}",
                "short": true
              },
              {
                "title": "ğŸ‘¤ ë°°í¬ì",
                "value": "${{ github.event.workflow_run.actor.login }}",
                "short": true
              },
              {
                "title": "â±ï¸ ì†Œìš” ì‹œê°„",
                "value": "ì•½ ${{ github.event.workflow_run.run_duration_ms }}ms",
                "short": true
              },
              {
                "title": "ğŸ”— ê²°ê³¼",
                "value": "<${{ github.event.workflow_run.html_url }}|ë°°í¬ ë¡œê·¸ ë³´ê¸°>",
                "short": false
              }
            ],
            "footer": "KDT Terraform Pipeline"
          }]
        }' \
        ${{ secrets.SLACK_WEBHOOK_URL }}
        
    - name: âŒ Workflow Failure
      if: github.event.workflow_run.status == 'completed' && github.event.workflow_run.conclusion == 'failure'
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data '{
          "channel": "#infrastructure",
          "username": "Terraform Bot",
          "icon_emoji": ":x:",
          "text": "âŒ Terraform ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!",
          "attachments": [{
            "color": "danger",
            "title": "ğŸš¨ ì¸í”„ë¼ ë°°í¬ ì‹¤íŒ¨",
            "fields": [
              {
                "title": "ğŸ“‹ ì›Œí¬í”Œë¡œìš°",
                "value": "${{ github.event.workflow_run.name }}",
                "short": true
              },
              {
                "title": "ğŸŒ¿ ë¸Œëœì¹˜",
                "value": "${{ github.event.workflow_run.head_branch }}",
                "short": true
              },
              {
                "title": "ğŸ‘¤ íŠ¸ë¦¬ê±°",
                "value": "${{ github.event.workflow_run.actor.login }}",
                "short": true
              },
              {
                "title": "âŒ ì‹¤íŒ¨ ì´ìœ ",
                "value": "${{ github.event.workflow_run.conclusion }}",
                "short": true
              },
              {
                "title": "ğŸ”— ë””ë²„ê·¸",
                "value": "<${{ github.event.workflow_run.html_url }}|ì‹¤íŒ¨ ë¡œê·¸ í™•ì¸>",
                "short": false
              }
            ],
            "footer": "KDT Terraform Pipeline"
          }]
        }' \
        ${{ secrets.SLACK_WEBHOOK_URL }}
        
    - name: âš ï¸ Workflow Cancelled
      if: github.event.workflow_run.status == 'completed' && github.event.workflow_run.conclusion == 'cancelled'
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data '{
          "channel": "#infrastructure",
          "username": "Terraform Bot",
          "icon_emoji": ":warning:",
          "text": "âš ï¸ Terraform ë°°í¬ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.",
          "attachments": [{
            "color": "warning",
            "title": "âš ï¸ ì¸í”„ë¼ ë°°í¬ ì·¨ì†Œ",
            "fields": [
              {
                "title": "ğŸ“‹ ì›Œí¬í”Œë¡œìš°",
                "value": "${{ github.event.workflow_run.name }}",
                "short": true
              },
              {
                "title": "ğŸŒ¿ ë¸Œëœì¹˜",
                "value": "${{ github.event.workflow_run.head_branch }}",
                "short": true
              },
              {
                "title": "ğŸ‘¤ ì·¨ì†Œì",
                "value": "${{ github.event.workflow_run.actor.login }}",
                "short": true
              },
              {
                "title": "ğŸ”— ë§í¬",
                "value": "<${{ github.event.workflow_run.html_url }}|ì›Œí¬í”Œë¡œìš° ë³´ê¸°>",
                "short": true
              }
            ],
            "footer": "KDT Terraform Pipeline"
          }]
        }' \
        ${{ secrets.SLACK_WEBHOOK_URL }}
